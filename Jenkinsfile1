pipeline {
    agent any

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'prod'], description: 'Select environment')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Init Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        script {
                            def envName = params.ENVIRONMENT
                            def tfvarsFile = "${envName}.tfvars"
                            def backendBucket = "my-app-bucket-ganesh-${envName}"
                            def awsRegion = "ap-south-1"

                            sh """
                                terraform init -reconfigure \
                                    -backend-config=bucket=${backendBucket} \
                                    -backend-config=key=${envName}/terraform.tfstate \
                                    -backend-config=region=${awsRegion}
                            """

                            def workspaces = sh(script: "terraform workspace list", returnStdout: true)
                                .trim()
                                .split("\\n")
                                .collect{ it.replace("*", "").trim() }

                            if (!workspaces.contains(envName)) {
                                sh "terraform workspace new ${envName}"
                            }

                            sh "terraform workspace select ${envName}"
                        }
                    }
                }
            }
        }

        stage('Plan Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform plan -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }

        stage('Apply Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform apply -auto-approve -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }
    }
}
