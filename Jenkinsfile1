pipeline {
    agent any
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'prod'], description: 'Select environment')
    }
    stages {
        stage('Init Terraform') {
            steps {
                dir('terraform') {
                    // Initialize Terraform
                    sh 'terraform init'
                    
                    // Handle workspaces
                    script {
                        def workspace = params.ENVIRONMENT
                        def existingWorkspaces = sh(script: 'terraform workspace list', returnStdout: true).trim().split("\n")
                        if (!existingWorkspaces.collect{ it.replace("*","").trim() }.contains(workspace)) {
                            sh "terraform workspace new ${workspace}"
                        } else {
                            sh "terraform workspace select ${workspace}"
                        }
                    }
                }
            }
        }
        stage('Plan Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform plan -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }
        stage('Apply Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform apply -auto-approve -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }
    }
}

