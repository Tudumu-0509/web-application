pipeline {
    agent any
    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'prod'], description: 'Select environment')
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Init Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        script {
                            def workspace = params.ENVIRONMENT
                            def tfvarsFile = "${workspace}.tfvars"
                            
                            // Select backend bucket based on environment
                            def backendBucket = (workspace == "dev") ? "terraform-state-ganesh-dev" : "terraform-state-ganesh-prod"
                            
                            // Initialize Terraform backend with environment-specific bucket
                            sh "terraform init -reconfigure -backend-config=bucket=${backendBucket} -backend-config=region=us-east-1 -var-file=${tfvarsFile}"
                            
                            // Handle Terraform workspaces
                            def existingWorkspaces = sh(script: 'terraform workspace list', returnStdout: true).trim().split("\n")
                            if (!existingWorkspaces.collect{ it.replace('*','').trim() }.contains(workspace)) {
                                sh "terraform workspace new ${workspace}"
                            } else {
                                sh "terraform workspace select ${workspace}"
                            }
                        }
                    }
                }
            }
        }
        stage('Plan Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform plan -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }
        stage('Apply Terraform') {
            steps {
                dir('terraform') {
                    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-cred']]) {
                        sh "terraform apply -auto-approve -var-file=${params.ENVIRONMENT}.tfvars"
                    }
                }
            }
        }
    }
}
